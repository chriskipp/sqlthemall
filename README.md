# sqlthemall

sqlthemall provides automatic generation of relational database schemas based on the structure of provided JSON objects as well as teir direct import into the (relational) database of your choice.

## Dependencies

Since sqlthemall makes heavy use of SqlAlchemy you need to install this package as a dependency. You will also need the package requests to retrive JSON documents directly from web sources such as API's.

All dependencies can be installed via:
```
$ pip install -U sqlalchemy requests
```

While SQLalchemy generally supports a wide range of different data bases the standard installation of sqlalchemy only supports SQLite. To be able to use other data bases you might wish to install further python packages providing SQLalchemy support for the database of your choice. You can find a quick overview of supported data bases as well as installation instructions for their SQLalchemy support [here](https://apache-superset.readthedocs.io/en/latest/installation.html#database-dependencies).

## Why this program?

Practically all of the data provided via web API's are in JSON format.  While JSON is a hierarchic data format (which can have nested sub objects as well as (sub)arrays) it is not directly possible to transform such data structures in a purely (single)tabular form (for example as CSV).

In contrast to formats like CSV, relational databases have the ability to provide relations between different types of objects and the relations in between them through Foreign Keys and/or Bridge Tables.
Since the conversion of JSON data to relational database schemas is usually still a manual process which can be very time consuming, depending on the complexity of the structure of the JSON object, this repository tries to automatize this process as far as possible. You should keep in mind that there is not the "one and only" correct way to represent the structure of a certain data set as a relational schema. The generated database schema generated therefore is directly representing  the structure inherited by the given JSON data.

## Usage

### sqlthemall.py

```sqlthemall.py``` in the current state is primarily ment to use as a command line script but can also be imported and used in python directly. The Usage is:


```
usage: sqlthemall [-h] -d DBURL [-u URL] [-f FILE] [-s] [-n] [-a] [-v] [-q]
                  [-t ROOT_TABLE]

optional arguments:
  -h, --help            show this help message and exit
  -d DBURL, --databaseurl DBURL
                        database url to use
  -u URL, --url URL     url to read JSON from
  -f FILE, --file FILE  file to read JSON from (default: stdin)
  -s, --simple          creates a simple database schema (no mtm)
  -n, --noimport        only creates database schema, skips import
  -a, --autocommit      opens database in autocommit mode
  -v, --verbose         print verbose output
  -q, --quiet           don't print output
  -t ROOT_TABLE, --root-table ROOT_TABLE
                        Name of the table to import the outermost subobjects
                        if JSON object is a array
```

After cloning this repository you should be able to run the following command:

```
python ./bin/sqlthemall.py -s -f data/example.json -d 'sqlite:///example.sqlite'
```
This will recursively parse the JSON data in the file ```data/example.json``` and generate the following database schema:

![simple schema](img/example.svg)
Image generated by [sadisplay](https://github.com/GoodRx/sadisplay) (requires sadisplay and graphviz):

```
sadisplay --url 'sqlite:///example.sqlite' | dot -Tpng > img/example.png
```

The command expects a ```-d/--databaseurl "database://user:password@host:port"``` option as a mandatory argument as well as either the ```-f/--file my_file.json``` or the ```-u/--url https://my_awesome_json_api.json``` option as a source to read the JSON data from (if both are omitted it tries to read a JSON object from stdin).


To make full use of the abilities of relational databases skip the ```-s``` option to create a database schema containing bridge tables to support many-to-many relationships.

```
python ./bin/sqlthemall.py -d 'sqlite:///countries.sqlite' -u 'https://restcountries.eu/rest/v2/all'
```

The above command will directly create a database schema from the JSON data returned by the API request. Beside the main table (main) representing the countries a set of country related tables such as used currencies, spoken languages, time zones, ... as well as all bridge tables necessary to provide the many-to-many-relationships are automatically created. 

![restcountries database schema](img/countries.svg)

By default the JSON data is automatically imported into the database in a second step (use the ```-n/--noimport``` option to skip the import step).

Further command line options are:

-  ```-a/--autocommit``` Opens the database in autocommit mode. Using this option will slow down the import process but has the advantage to import the given JSON data even if the insertion of one or more subobjects into the database fails for some reason.
-  ```-n/--noimport``` Only creates the tables of the database schema but skips the import of the provided data into the tables
-  ```-q/--quiet``` Will turn off the output of the command completely
-  ```-v/--verbose``` Will turn on verbose output that also sends a message for every column that already exists as well as every object imported into the database as a dict.
-  ```-t/--root-table``` Defines the name of the root table to import the outermost objects in case the provided JSON is a array

## Usage Hints/Where to go from here?

While sqlthemall provides the generation of a database schema as well as the import of data in the JSON format, might want to use it in combination with software from other repositories :
- [public-apis](https://github.com/public-apis/public-apis) provides a list of public API's that allow you to retrieve data in the JSON format
- [sadisplay](https://github.com/GoodRx/sadisplay) allows you to display the generated database schemas. In combination with sqlthemall this allows you to quickly get a overview of the structure of JSON data
- [sqlcodegen](https://github.com/agronholm/sqlacodegen) automatically generates the code for SQLalchemy style python classes that allow directly access of the imported data in a object oriented manner
