# sqlthemall

sqlthemall provides automatic generation of relational database schemas based on the structure of provided JSON objects as well as teir direct import into the (relational) database of your choice.

## Installation

### Dependencies

- [SQLalchemy](https://www.sqlalchemy.org) Since sqlthemall uses to access the different databases this package is mandatory. 
- [orjson](https://github.com/ijl/orjson) To speed up the parsing of JSON objects. If installed it will be used as a replacement for the ```json``` package of the standart library. This package is a optional dependency.
- [requests](https://requests.readthedocs.io/en/master) If installed this package will be used to retrive JSON data directly from web sources such as API's. As a fallback the ```urllib.requests``` module of the python standart library will be used.

### Setup

This package and all dependencies can be installed via:
```
$ python -m pip install .
```

While SQLalchemy generally supports a wide range of different data bases the standard installation of SQLalchemy only supports SQLite. To be able to use other data bases you might wish to install further python packages providing SQLalchemy support for the database of your choice. You can find a quick overview of supported data bases as well as installation instructions for their SQLalchemy support [here](https://apache-superset.readthedocs.io/en/latest/installation.html#database-dependencies).

## Usage

### Quickstart

After installation you should be able to run the following command:

```
sqlthemall -s -f data/example.json -d 'sqlite:///example.sqlite'
```
This will recursively parse the JSON data in the file ```data/example.json``` and generate the following database schema:

![simple schema](img/example.svg)
Image generated by [sadisplay](https://github.com/GoodRx/sadisplay) (requires sadisplay and graphviz):

```
sadisplay --url 'sqlite:///example.sqlite' | dot -Tsvg > img/examplesvg.
```

The command expects a ```-d/--databaseurl "database://user:password@host:port"``` option as a mandatory argument as well as either the ```-f/--file my_file.json``` or the ```-u/--url https://my_awesome_json_api.json``` option as a source to read the JSON data from (if both are omitted it tries to read a JSON data from stdin).

To make full use of the abilities of relational databases skip the ```-s``` option to create a database schema containing bridge tables to support many-to-many relationships.

```
sqlthemall -d 'sqlite:///countries.sqlite' -u 'https://restcountries.eu/rest/v2/all' -t 'countries'
```

The above command will download the JSON data returned by the API request. Beside the root_taable table (named 'countries' throucg the -c option) containing the database entries for the countries itself, all the data provided in the JSON document is represented as a set of country related tables such as used currencies, spoken languages, time zones, ... The relations between the different types of database objects are represented in the form of foreign keys/bridge tables. 

![restcountries database schema](img/countries.svg)

### Further command line options

The behaviour of ```sqlthemall``` can be further adjusted by several command line options. The Usage is:

```
Usage: sqlthemall [-h] -d DBURL [-u URL] [-f FILE] [-s] [-n] [-a] [-v] [-q] [-e]
               [-t ROOT_TABLE] [-l] [-S]

optional arguments:
  -h, --help            show this help message and exit
  -d DBURL, --databaseurl DBURL
                        Database url to use
  -u URL, --url URL     URL to read JSON from
  -f FILE, --file FILE  File to read JSON from (default: stdin)
  -s, --simple          Creates a simple database schema (no mtm)
  -n, --noimport        Only creates database schema, skips import
  -a, --autocommit      Opens database in autocommit mode
  -v, --verbose         Print verbose output
  -q, --quiet           Don't print output
  -e, --echo            Print SQL statements (engine.echo = True)
  -t ROOT_TABLE, --root-table ROOT_TABLE
                        Name of the table to import the outermost subobjects
                        if JSON object is a array
  -l, --line            Uses JSONline instead of JSON
  -S, --sequential      Processes objects in JSONline mode in sequential order
```

## Usage Hints/Where to go from here?

While sqlthemall provides the generation of a database schema as well as the import of data in the JSON format, you might want to use it in combination with software from other repositories :
- [sadisplay](https://github.com/GoodRx/sadisplay) allows you to display the generated database schemas. In combination with sqlthemall this allows you to quickly get a overview of the structure of JSON data
- [sqlcodegen](https://github.com/agronholm/sqlacodegen) automatically generates the code for SQLalchemy style python classes that allow directly access of the imported data in a object oriented manner
- [public-apis](https://github.com/public-apis/public-apis) provides a list of public API's that allow you to retrieve data in the JSON format

## Why this program?

Practically all of the data provided via web API's are in JSON format. While JSON is a hierarchic data format (which can have nested sub objects as well as (sub)arrays) it is not directly possible to transform such data structures in a purely (single)tabular form (for example as CSV).

In contrast to formats like CSV, relational databases have the ability to provide relations between different types of objects and the relations in between them through foreign keys and/or bridge tables.
Since the conversion of JSON data to a form that fits relational databases is usually still a manual process which can be very time consuming, depending on the complexity of the provided JSON data, this repository tries to automatize this process as far as possible. You should keep in mind that there is not the "one and only" correct way to represent the structure of a certain data set as a relational schema. The generated database schemas therefore are a direct representation of the structure inherited by the given JSON data.

